apiVersion: serving.knative.dev/v1 # Current version of Knative
kind: Service
metadata:
  name: scan-queue
  namespace: scanners
  labels:
    app: scanners
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        # Knative concurrency-based autoscaling (default).
        autoscaling.knative.dev/class: kpa.autoscaling.knative.dev
        autoscaling.knative.dev/metric: concurrency
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "1"
    spec:
      timeoutSeconds: 500
      containers:
      - name: scan-queue
        image: gcr.io/track-compliance/services/queues/scan:master-aae5946-1627998662 # {"$imagepolicy": "flux-system:scan-queue"}
---
apiVersion: serving.knative.dev/v1 # Current version of Knative
kind: Service
metadata:
  name: result-queue
  namespace: scanners
  labels:
    app: scanners
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        # Knative concurrency-based autoscaling (default).
        autoscaling.knative.dev/class: kpa.autoscaling.knative.dev
        autoscaling.knative.dev/metric: concurrency
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "1"
    spec:
      timeoutSeconds: 500
      containers:
      - name: result-queue
        image: gcr.io/track-compliance/services/queues/result:master-aae5946-1627998666 # {"$imagepolicy": "flux-system:result-queue"}
---
apiVersion: serving.knative.dev/v1 # Current version of Knative
kind: Service
metadata:
  name: ots-scan-queue
  namespace: scanners
  labels:
    app: scanners
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        # Knative concurrency-based autoscaling (default).
        autoscaling.knative.dev/class: kpa.autoscaling.knative.dev
        autoscaling.knative.dev/metric: concurrency
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "1"
    spec:
      timeoutSeconds: 500
      containers:
      - name: ots-scan-queue
        image: gcr.io/track-compliance/services/queues/ots-scan:master-aae5946-1627998661 # {"$imagepolicy": "flux-system:ots-scan-queue"}
        env:
        - name: PUBSUB_HOST
          valueFrom:
            secretKeyRef:
              name: scanners
              key: REDIS_HOST
        - name: PUBSUB_PORT
          valueFrom:
            secretKeyRef:
              name: scanners
              key: REDIS_PORT
---
apiVersion: serving.knative.dev/v1 # Current version of Knative
kind: Service
metadata:
  name: ots-result-queue
  namespace: scanners
  labels:
    app: scanners
spec:
  template:
    metadata:
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '9090'
        # Knative concurrency-based autoscaling (default).
        autoscaling.knative.dev/class: kpa.autoscaling.knative.dev
        autoscaling.knative.dev/metric: concurrency
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "1"
    spec:
      timeoutSeconds: 500
      containers:
      - name: ots-result-queue
        image: gcr.io/track-compliance/services/queues/ots-result:master-aae5946-1627998663 # {"$imagepolicy": "flux-system:ots-result-queue"}
        env:
        - name: PUBSUB_HOST
          valueFrom:
            secretKeyRef:
              name: scanners
              key: REDIS_HOST
        - name: PUBSUB_PORT
          valueFrom:
            secretKeyRef:
              name: scanners
              key: REDIS_PORT
