steps:

    - name: 'gcr.io/cloud-builders/docker'
      id: start_arango
      entrypoint: /bin/sh
      args:
        [
          "-c",
          "docker run -d --network=cloudbuild -p=8529:8529 -e ARANGO_ROOT_PASSWORD=$DB_PASS --name=arango gcr.io/track-compliance/arangodb:latest",
        ]

    - name: mikewilliamson/wait-for
      id: wait
      args: ['arango:8529']

    - name: node:alpine
      id: install
      dir: api-js
      entrypoint: npm
      args: ['ci', '--no-optional']
  
    - name: node:alpine
      id: lint
      dir: api-js
      entrypoint: npm
      args: ['run', lint]
  
    - name: node:alpine
      id: test
      dir: api-js
      entrypoint: npm
      args: ['test']
      env:
        - DB_URL=$_DB_URL
        - DB_PASS=$_DB_PASS
  
    - name: 'gcr.io/cloud-builders/docker'
      id: build-if-master
      entrypoint: 'bash'
      dir: .
      args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "master" ]]
        then
          docker build -t gcr.io/$PROJECT_ID/dmarc-report-api:$BRANCH_NAME-$SHORT_SHA .
        else
          exit 0
        fi
    - name: 'gcr.io/cloud-builders/docker'
      id: push-if-master
      entrypoint: 'bash'
      args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "master" ]]
        then
          docker push gcr.io/$PROJECT_ID/dmarc-report-api:$BRANCH_NAME-$SHORT_SHA
        else
          exit 0
        fi