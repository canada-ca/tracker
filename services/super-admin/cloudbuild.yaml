steps:
- name: 'gcr.io/cloud-builders/docker'
  id: start_arango
  entrypoint: /bin/sh
  args:
    [
      '-c',
      'docker run -d --network=cloudbuild -p=8529:8529 -e ARANGO_ROOT_PASSWORD=$_DB_PASS --name=arangodb arangodb',
    ]

- name: mikewilliamson/wait-for
  id: wait
  args: ['arangodb:8529']

- name: node:alpine
  id: install-dependencies
  dir: services/super-admin
  entrypoint: npm
  args: ['ci', '--no-optional']

- name: node:alpine
  id: run-eslint
  dir: services/super-admin
  entrypoint: npm
  args: ['run', lint]

- name: node:alpine
  id: test
  dir: services/super-admin
  entrypoint: npm
  args: ['test']
  env:
    - DB_URL=$_DB_URL
    - DB_PASS=$_DB_PASS
    - DB_NAME=$_DB_NAME

- name: 'gcr.io/cloud-builders/docker'
  id: build-if-master
  entrypoint: 'bash'
  dir: services/super-admin
  args:
    - '-c'
    - |
      if [[ "$BRANCH_NAME" == "master" ]]
      then
        docker build -t gcr.io/$PROJECT_ID/super-admin:$BRANCH_NAME-$SHORT_SHA .
      else
        exit 0
      fi

- name: 'gcr.io/cloud-builders/docker'
  id: push-if-master
  dir: services/super-admin
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      if [[ "$BRANCH_NAME" == "master" ]]
      then
        docker push gcr.io/$PROJECT_ID/super-admin:$BRANCH_NAME-$SHORT_SHA
      else
        exit 0
      fi
