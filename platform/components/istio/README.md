# Istio

This folder contains the config for [Istio](https://istio.io/latest/), which acts as the ingress gateway for the Tracker system.

## Installing `istioctl`

The `istioctl` command needs to be available in your PATH. Instructions for installing it are on the [Istio website](https://istio.io/latest/docs/setup/getting-started/#download).

## Updating the Istio config

The config found in `platform/components/istio/istio.yaml` is generated by the `make update-istio` command. After installing a new version of `istioctl` you should rerun this command to update the that file.

Istio's config leaves extra ports open, and our config removes this ports by applying [strategic merge patch](https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md). You can (and should) test that the patch removes all ports but 80 and 443 after upgrading.

If you have [`yq`](https://pypi.org/project/yq/) and [`jq`](https://stedolan.github.io/jq/download/) installed, you can verify this with `make print-ingress` which should output something like this, specifying that only ports 80 and 443 are open:

```
[mike@ouroboros tracker]$ make print-ingress 
kustomize build platform/test | yq -y '. | select(.kind == "Service" and .metadata.name == "istio-ingressgateway")'
apiVersion: v1
kind: Service
metadata:
  labels:
    app: istio-ingressgateway
    install.operator.istio.io/owning-resource: unknown
    istio: ingressgateway
    istio.io/rev: default
    operator.istio.io/component: IngressGateways
    release: istio
  name: istio-ingressgateway
  namespace: istio-system
spec:
  ports:
    - name: http2
      port: 80
      protocol: TCP
      targetPort: 8080
    - name: https
      port: 443
      protocol: TCP
      targetPort: 8443
  selector:
    app: istio-ingressgateway
    istio: ingressgateway
  type: LoadBalancer

```
